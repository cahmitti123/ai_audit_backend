# Project Intelligence (Cursor)

## Non-negotiables
- Never commit real secrets; use placeholders.
- Use `npm run build` to confirm TypeScript is green after substantial changes.

## Inngest patterns
- **Do not nest `step.*` calls inside `step.run`** (avoid `NESTING_STEPS`).
  - Good: compute data inside `step.run`, then call `step.sendEvent` at top-level.
  - Good: use separate `step.run` for DB writes after emitting events.
- When emitting multiple events, prefer a single `step.sendEvent("some-step", eventsArray)`.
- When dealing with Inngest `JsonifyObject` typing (step results), cast via `unknown` first to avoid incompatible deep types.
- Keep `/api/inngest` error responses standard: normalize upstream 5xx AppError status codes (eg 502) to HTTP 500 so the Inngest engine doesn’t reject them.

## Automation scheduling
- Scheduler tick is `scheduledAutomationCheck` (Inngest cron).
- Default tick is every minute; can override with `AUTOMATION_SCHEDULER_CRON`.
- “Due” detection is window-based using timezone-aware cron matching.

## Webhooks / realtime
- Central webhook sender is `src/shared/webhook.ts`.
- For user-provided webhook URLs (progressive fetch), validate with SSRF guard.
- For debugging webhook failures, log axios `code`, `status`, and URL path (avoid full secret leakage).

## CRM load protection
- Avoid fanning out day-by-day CRM sales searches across replicas; prefer a single date-range sales search (`fiches/cache-sales-list`) and then process/update job state.
- Keep CRM-bound concurrency **small and global** by default (don’t scale with replicas):
  - `FICHE_SALES_SEARCH_CONCURRENCY` (default `1`) for `/sales-with-calls` searches
  - `FICHE_FETCH_CONCURRENCY` (default `3`) for fiche by-id detail fetches






