// Backend Database Schema - AI Audit System
// ==========================================
// Main database for the audit backend service

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider  = "postgresql"
    url       = env("DATABASE_URL")
    directUrl = env("DIRECT_URL")
}

model AuditConfig {
    id           BigInt  @id @default(autoincrement())
    name         String
    description  String? @db.Text
    systemPrompt String? @map("system_prompt") @db.Text

    isActive         Boolean  @default(true) @map("is_active")
    runAutomatically Boolean  @default(false) @map("run_automatically")
    createdBy        String?  @map("created_by")
    createdAt        DateTime @default(now()) @map("created_at")
    updatedAt        DateTime @updatedAt @map("updated_at")

    audits Audit[]
    steps  AuditStep[]

    @@index([isActive])
    @@index([runAutomatically])
    @@index([createdAt])
    @@map("audit_configs")
}

model AuditStep {
    id            BigInt      @id @default(autoincrement())
    auditConfigId BigInt      @map("audit_config_id")
    auditConfig   AuditConfig @relation(fields: [auditConfigId], references: [id], onDelete: Cascade)

    name                   String
    description            String?       @db.Text
    prompt                 String        @db.Text
    controlPoints          String[]      @map("control_points")
    keywords               String[]
    severityLevel          AuditSeverity @map("severity_level")
    isCritical             Boolean       @default(false) @map("is_critical")
    position               Int
    chronologicalImportant Boolean       @default(false) @map("chronological_important")
    weight                 Int           @default(5)
    verifyProductInfo      Boolean       @default(false) @map("verify_product_info")

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@index([auditConfigId])
    @@index([position])
    @@map("audit_steps")
}

enum AuditSeverity {
    LOW
    MEDIUM
    HIGH
    CRITICAL
}

model FicheCache {
    id             BigInt  @id @default(autoincrement())
    ficheId        String  @unique @map("fiche_id")
    groupe         String?
    agenceNom      String? @map("agence_nom")
    prospectNom    String? @map("prospect_nom")
    prospectPrenom String? @map("prospect_prenom")
    prospectEmail  String? @map("prospect_email")
    prospectTel    String? @map("prospect_tel")

    // Sales date tracking - which CRM date this fiche belongs to
    salesDate String? @map("sales_date") // YYYY-MM-DD format - date from CRM sales list

    rawData           Json      @map("raw_data")
    hasRecordings     Boolean   @default(false) @map("has_recordings")
    recordingsCount   Int?      @map("recordings_count")
    fetchedAt         DateTime  @default(now()) @map("fetched_at")
    expiresAt         DateTime  @map("expires_at")
    lastRevalidatedAt DateTime? @map("last_revalidated_at")
    createdAt         DateTime  @default(now()) @map("created_at")
    updatedAt         DateTime  @updatedAt @map("updated_at")

    audits     Audit[]
    recordings Recording[]

    @@index([ficheId])
    @@index([expiresAt])
    @@index([groupe])
    @@index([salesDate])
    @@index([lastRevalidatedAt])
    @@map("fiche_cache")
}

model Recording {
    id           BigInt     @id @default(autoincrement())
    ficheCacheId BigInt     @map("fiche_cache_id")
    ficheCache   FicheCache @relation(fields: [ficheCacheId], references: [id], onDelete: Cascade)

    callId            String    @map("call_id")
    recordingUrl      String    @map("recording_url")
    recordingDate     String?   @map("recording_date")
    recordingTime     String?   @map("recording_time")
    fromNumber        String?   @map("from_number")
    toNumber          String?   @map("to_number")
    uuid              String?
    direction         String?
    answered          Boolean?
    startTime         DateTime? @map("start_time")
    durationSeconds   Int?      @map("duration_seconds")
    transcriptionId   String?   @map("transcription_id")
    transcriptionText String?   @map("transcription_text") @db.Text
    hasTranscription  Boolean   @default(false) @map("has_transcription")
    transcribedAt     DateTime? @map("transcribed_at")
    createdAt         DateTime  @default(now()) @map("created_at")
    updatedAt         DateTime  @updatedAt @map("updated_at")

    @@unique([ficheCacheId, callId])
    @@index([ficheCacheId])
    @@index([callId])
    @@index([recordingDate])
    @@map("recordings")
}

model Audit {
    id BigInt @id @default(autoincrement())

    ficheCacheId  BigInt      @map("fiche_cache_id")
    ficheCache    FicheCache  @relation(fields: [ficheCacheId], references: [id])
    auditConfigId BigInt      @map("audit_config_id")
    auditConfig   AuditConfig @relation(fields: [auditConfigId], references: [id])

    overallScore    Decimal @map("overall_score") @db.Decimal(5, 2)
    scorePercentage Decimal @map("score_percentage") @db.Decimal(5, 2)
    niveau          String
    isCompliant     Boolean @map("is_compliant")
    criticalPassed  Int     @map("critical_passed")
    criticalTotal   Int     @map("critical_total")

    status       String    @default("pending")
    startedAt    DateTime? @map("started_at")
    completedAt  DateTime? @map("completed_at")
    durationMs   Int?      @map("duration_ms")
    errorMessage String?   @map("error_message") @db.Text

    totalTokens     Int? @map("total_tokens")
    successfulSteps Int? @map("successful_steps")
    failedSteps     Int? @map("failed_steps")
    recordingsCount Int? @map("recordings_count")
    timelineChunks  Int? @map("timeline_chunks")

    resultData Json?   @map("result_data")
    version    Int     @default(1)
    isLatest   Boolean @default(true) @map("is_latest")

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    stepResults AuditStepResult[]

    @@index([ficheCacheId])
    @@index([auditConfigId])
    @@index([status])
    @@index([isCompliant])
    @@index([createdAt])
    @@index([isLatest])
    @@map("audits")
}

model AuditStepResult {
    id      BigInt @id @default(autoincrement())
    auditId BigInt @map("audit_id")
    audit   Audit  @relation(fields: [auditId], references: [id], onDelete: Cascade)

    stepPosition                 Int      @map("step_position")
    stepName                     String   @map("step_name")
    severityLevel                String   @map("severity_level")
    isCritical                   Boolean  @map("is_critical")
    weight                       Int
    traite                       Boolean
    conforme                     String
    score                        Int
    niveauConformite             String   @map("niveau_conformite")
    commentaireGlobal            String   @map("commentaire_global") @db.Text
    motsClesTrouves              String[] @map("mots_cles_trouves")
    minutages                    String[]
    erreursTranscriptionTolerees Int      @default(0) @map("erreurs_transcription_tolerees")
    totalCitations               Int      @default(0) @map("total_citations")
    totalTokens                  Int      @default(0) @map("total_tokens")
    createdAt                    DateTime @default(now()) @map("created_at")

    @@index([auditId])
    @@index([stepPosition])
    @@index([conforme])
    @@map("audit_step_results")
}

// ═══════════════════════════════════════════════════════════════════════════════
// CHAT SYSTEM
// ═══════════════════════════════════════════════════════════════════════════════

model ChatConversation {
    id      BigInt  @id @default(autoincrement())
    ficheId String  @map("fiche_id")
    auditId BigInt? @map("audit_id") // null = fiche-level chat

    title     String?
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    messages ChatMessage[]

    @@unique([ficheId, auditId])
    @@index([ficheId])
    @@index([auditId])
    @@index([createdAt])
    @@map("chat_conversations")
}

model ChatMessage {
    id             BigInt           @id @default(autoincrement())
    conversationId BigInt           @map("conversation_id")
    conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

    role      String // "user" | "assistant" | "system"
    content   String   @db.Text
    timestamp DateTime @default(now())

    @@index([conversationId])
    @@index([timestamp])
    @@map("chat_messages")
}

// ═══════════════════════════════════════════════════════════════════════════════
// AUTOMATION SYSTEM
// ═══════════════════════════════════════════════════════════════════════════════

model AutomationSchedule {
    id          BigInt   @id @default(autoincrement())
    name        String
    description String?  @db.Text
    isActive    Boolean  @default(true) @map("is_active")
    createdBy   String?  @map("created_by")
    createdAt   DateTime @default(now()) @map("created_at")
    updatedAt   DateTime @updatedAt @map("updated_at")

    // Schedule Configuration
    scheduleType   ScheduleType @map("schedule_type")
    cronExpression String?      @map("cron_expression") // For custom cron
    timezone       String       @default("UTC")
    timeOfDay      String?      @map("time_of_day") // HH:MM format
    dayOfWeek      Int?         @map("day_of_week") // 0-6 (Sunday-Saturday)
    dayOfMonth     Int?         @map("day_of_month") // 1-31

    // Fiche Selection Configuration
    ficheSelection Json @map("fiche_selection") // Flexible JSON config
    // Example JSON structure:
    // {
    //   "mode": "date_range" | "manual" | "filter",
    //   "dateRange": "last_24h" | "yesterday" | "last_week" | "last_month" | "custom",
    //   "customStartDate": "2024-01-01",
    //   "customEndDate": "2024-01-31",
    //   "groupes": ["groupe1", "groupe2"],
    //   "onlyWithRecordings": true,
    //   "onlyUnaudited": false,
    //   "maxFiches": 100,
    //   "ficheIds": ["123", "456"] // For manual mode
    // }

    // Transcription Configuration
    runTranscription      Boolean @default(true) @map("run_transcription")
    skipIfTranscribed     Boolean @default(true) @map("skip_if_transcribed")
    transcriptionPriority String  @default("normal") @map("transcription_priority") // normal, high, low

    // Audit Configuration
    runAudits            Boolean  @default(true) @map("run_audits")
    useAutomaticAudits   Boolean  @default(true) @map("use_automatic_audits") // Use audits marked as automatic
    specificAuditConfigs BigInt[] @map("specific_audit_configs") // Specific audit config IDs to run

    // Error Handling Configuration
    continueOnError Boolean @default(true) @map("continue_on_error")
    retryFailed     Boolean @default(false) @map("retry_failed")
    maxRetries      Int     @default(0) @map("max_retries")

    // Notification Configuration
    notifyOnComplete Boolean  @default(true) @map("notify_on_complete")
    notifyOnError    Boolean  @default(true) @map("notify_on_error")
    webhookUrl       String?  @map("webhook_url")
    notifyEmails     String[] @map("notify_emails")

    // External API Configuration
    externalApiKey String? @map("external_api_key") // Optional per-schedule API key

    // Execution History
    runs           AutomationRun[]
    lastRunAt      DateTime?       @map("last_run_at")
    lastRunStatus  String?         @map("last_run_status") // success, partial, failed
    totalRuns      Int             @default(0) @map("total_runs")
    successfulRuns Int             @default(0) @map("successful_runs")
    failedRuns     Int             @default(0) @map("failed_runs")

    @@index([isActive])
    @@index([scheduleType])
    @@index([lastRunAt])
    @@index([createdAt])
    @@map("automation_schedules")
}

enum ScheduleType {
    MANUAL // Trigger manually via API
    DAILY // Every day at specified time
    WEEKLY // Specific day of week at specified time
    MONTHLY // Specific day of month at specified time
    CRON // Custom cron expression
}

model AutomationRun {
    id         BigInt             @id @default(autoincrement())
    scheduleId BigInt             @map("schedule_id")
    schedule   AutomationSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

    // Execution Details
    status      String    @default("running") // running, completed, partial, failed
    startedAt   DateTime  @default(now()) @map("started_at")
    completedAt DateTime? @map("completed_at")
    durationMs  Int?      @map("duration_ms")

    // Execution Stats
    totalFiches       Int @default(0) @map("total_fiches")
    successfulFiches  Int @default(0) @map("successful_fiches")
    failedFiches      Int @default(0) @map("failed_fiches")
    transcriptionsRun Int @default(0) @map("transcriptions_run")
    auditsRun         Int @default(0) @map("audits_run")

    // Error Information
    errorMessage String? @map("error_message") @db.Text
    errorDetails Json?   @map("error_details")

    // Configuration Snapshot (what was run)
    configSnapshot Json @map("config_snapshot")

    // Results Summary
    resultSummary Json? @map("result_summary")
    // Example JSON:
    // {
    //   "ficheIds": ["123", "456"],
    //   "auditIds": [789, 790],
    //   "errors": [],
    //   "warnings": []
    // }

    // Execution Logs
    logs AutomationLog[]

    @@index([scheduleId])
    @@index([status])
    @@index([startedAt])
    @@map("automation_runs")
}

model AutomationLog {
    id    BigInt        @id @default(autoincrement())
    runId BigInt        @map("run_id")
    run   AutomationRun @relation(fields: [runId], references: [id], onDelete: Cascade)

    level     String // info, warning, error, debug
    message   String   @db.Text
    metadata  Json?    @default("{}")
    timestamp DateTime @default(now())

    @@index([runId])
    @@index([level])
    @@index([timestamp])
    @@map("automation_logs")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PROGRESSIVE FETCH JOB TRACKING
// ═══════════════════════════════════════════════════════════════════════════════

model ProgressiveFetchJob {
    id        String @id @default(cuid())
    startDate String @map("start_date") // YYYY-MM-DD
    endDate   String @map("end_date") // YYYY-MM-DD

    // Job Status
    status        String @default("pending") // pending, processing, complete, failed
    progress      Int    @default(0) // 0-100
    totalDays     Int    @map("total_days")
    completedDays Int    @default(0) @map("completed_days")
    totalFiches   Int    @default(0) @map("total_fiches")

    // Dates tracking
    datesAlreadyFetched String[] @map("dates_already_fetched")
    datesRemaining      String[] @map("dates_remaining")
    datesFailed         String[] @map("dates_failed")

    // Webhook configuration
    webhookUrl        String?   @map("webhook_url")
    webhookSecret     String?   @map("webhook_secret")
    webhookEvents     String[]  @default(["complete", "failed"]) @map("webhook_events")
    lastWebhookSentAt DateTime? @map("last_webhook_sent_at")
    webhookAttempts   Int       @default(0) @map("webhook_attempts")
    webhookLastError  String?   @map("webhook_last_error")

    // Results
    resultFicheIds String[] @map("result_fiche_ids")
    error          String?  @map("error") @db.Text

    // Timestamps
    createdAt   DateTime  @default(now()) @map("created_at")
    updatedAt   DateTime  @updatedAt @map("updated_at")
    completedAt DateTime? @map("completed_at")

    // Relations
    webhookDeliveries WebhookDelivery[]

    // Indexes for performance
    @@index([status])
    @@index([startDate, endDate])
    @@index([createdAt])
    @@index([completedAt])
    @@map("progressive_fetch_jobs")
}

model WebhookDelivery {
    id    String              @id @default(cuid())
    jobId String              @map("job_id")
    job   ProgressiveFetchJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

    // Webhook details
    event   String // "progress" | "complete" | "failed"
    url     String
    payload Json

    // Delivery status
    status       String  @default("pending") // pending, sent, failed
    statusCode   Int?    @map("status_code")
    responseBody String? @map("response_body") @db.Text

    // Retry logic
    attempt     Int       @default(1)
    maxAttempts Int       @default(3) @map("max_attempts")
    nextRetryAt DateTime? @map("next_retry_at")

    // Timestamps
    sentAt    DateTime? @map("sent_at")
    createdAt DateTime  @default(now()) @map("created_at")

    // Indexes
    @@index([jobId])
    @@index([status, nextRetryAt])
    @@index([event])
    @@index([createdAt])
    @@map("webhook_deliveries")
}

// ═══════════════════════════════════════════════════════════════════════════════
// INSURANCE PRODUCTS SYSTEM
// ═══════════════════════════════════════════════════════════════════════════════

model Groupe {
    id        BigInt   @id @default(autoincrement()) @map("groupe_id")
    code      String   @map("id") @db.VarChar(2)
    libelle   String   @db.VarChar(17)
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    gammes Gamme[]

    @@index([libelle])
    @@map("groupes")
}

model Gamme {
    id        BigInt   @id @default(autoincrement()) @map("gamme_id")
    groupeId  BigInt   @map("groupe_id")
    groupe    Groupe   @relation(fields: [groupeId], references: [id], onDelete: Cascade)
    documents Json     @db.JsonB
    code      String   @map("id") @db.VarChar(3)
    libelle   String   @db.VarChar(29)
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    formules        Formule[]
    garantiesParsed GarantieParsed[]
    documentsTable  Document[]

    @@index([groupeId], map: "idx_gammes_groupe")
    @@index([libelle], map: "idx_gammes_libelle")
    @@map("gammes")
}

model Formule {
    id                  BigInt   @id @default(autoincrement()) @map("formule_id")
    gammeId             BigInt   @map("gamme_id")
    gamme               Gamme    @relation(fields: [gammeId], references: [id], onDelete: Cascade)
    appareilsAuditifs   String?  @map("appareils_auditifs") @db.VarChar(46)
    chambreParticuliere String?  @map("chambre_particuliere") @db.VarChar(47)
    cureThermale        String?  @map("cure_thermale") @db.VarChar(42)
    delaiAttente        String?  @map("delai_attente") @db.VarChar(50)
    dentaire            String?  @map("dentaire") @db.VarChar(50)
    fraisDossier        String?  @map("frais_dossier") @db.VarChar(13)
    garantiesHtml       String   @map("garanties_html") @db.VarChar(87)
    hospiNonOptam       String?  @map("hospi_non_optam") @db.VarChar(4)
    hospitalisation     String?  @map("hospitalisation") @db.VarChar(46)
    code                String   @map("id") @db.VarChar(4)
    libelle             String   @db.VarChar(14)
    libelleAlternatif   String?  @map("libelle_alternatif") @db.VarChar(13)
    maternite           String?  @map("maternite") @db.VarChar(48)
    medecineDouce       String?  @map("medecine_douce") @db.VarChar(40)
    medecines           String?  @map("medecines") @db.VarChar(50)
    optique             String?  @map("optique") @db.VarChar(50)
    optiqueVc           String?  @map("optique_vc") @db.VarChar(43)
    soinsNonOptam       String?  @map("soins_non_optam") @db.VarChar(12)
    createdAt           DateTime @default(now()) @map("created_at")
    updatedAt           DateTime @updatedAt @map("updated_at")

    garantiesParsed GarantieParsed[]
    documents       Document[]

    @@index([gammeId], map: "idx_formules_gamme")
    @@index([libelle], map: "idx_formules_libelle")
    @@map("formules")
}

model GarantieParsed {
    id               BigInt   @id @default(autoincrement()) @map("garantie_parsed_id")
    gammeId          BigInt?  @map("gamme_id")
    gamme            Gamme?   @relation(fields: [gammeId], references: [id], onDelete: Cascade)
    formuleId        BigInt?  @map("formule_id")
    formule          Formule? @relation(fields: [formuleId], references: [id], onDelete: Cascade)
    title            String?  @db.VarChar(255)
    introText        String[] @map("intro_text")
    formuleIndicator String?  @map("formule_indicator") @db.VarChar(50)
    notesAndLegal    String?  @map("notes_and_legal") @db.Text
    createdAt        DateTime @default(now()) @map("created_at")

    categories GarantieCategory[]

    @@index([gammeId], map: "idx_garanties_parsed_gamme")
    @@index([formuleId], map: "idx_garanties_parsed_formule")
    @@map("garanties_parsed")
}

model GarantieCategory {
    id               BigInt         @id @default(autoincrement()) @map("category_id")
    garantieParsedId BigInt         @map("garantie_parsed_id")
    garantieParsed   GarantieParsed @relation(fields: [garantieParsedId], references: [id], onDelete: Cascade)
    sectionIndex     Int            @map("section_index")
    categoryName     String         @map("category_name") @db.Text
    displayOrder     Int            @default(0) @map("display_order")
    createdAt        DateTime       @default(now()) @map("created_at")

    items GarantieItem[]

    @@index([garantieParsedId], map: "idx_categories_parsed")
    @@index([categoryName], map: "idx_categories_name")
    @@map("garantie_categories")
}

model GarantieItem {
    id             BigInt           @id @default(autoincrement()) @map("item_id")
    categoryId     BigInt           @map("category_id")
    category       GarantieCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
    guaranteeName  String           @map("guarantee_name") @db.Text
    guaranteeValue String           @map("guarantee_value") @db.Text
    displayOrder   Int              @default(0) @map("display_order")
    createdAt      DateTime         @default(now()) @map("created_at")

    @@index([categoryId], map: "idx_items_category")
    @@index([guaranteeName], map: "idx_items_name")
    @@map("garantie_items")
}

model Document {
    id           BigInt   @id @default(autoincrement()) @map("document_id")
    gammeId      BigInt?  @map("gamme_id")
    gamme        Gamme?   @relation(fields: [gammeId], references: [id], onDelete: Cascade)
    formuleId    BigInt?  @map("formule_id")
    formule      Formule? @relation(fields: [formuleId], references: [id], onDelete: Cascade)
    documentType String   @map("document_type") @db.VarChar(50)
    url          String   @db.Text
    createdAt    DateTime @default(now()) @map("created_at")

    @@index([gammeId], map: "idx_documents_gamme")
    @@index([formuleId], map: "idx_documents_formule")
    @@index([documentType], map: "idx_documents_type")
    @@map("documents")
}
